<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Test - LearnTAV</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e5e5;
        }
        .test-section:last-child {
            border-bottom: none;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        h2 {
            color: #2563eb;
            margin-bottom: 15px;
        }
        .credentials {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
            margin-bottom: 20px;
        }
        .credentials h3 {
            margin-top: 0;
            color: #1f2937;
        }
        .credentials p {
            margin: 5px 0;
            font-family: 'Courier New', monospace;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e5e5e5;
        }
        button {
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px 10px 5px 0;
            transition: all 0.2s ease;
        }
        button:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }
        button.admin {
            background: #dc2626;
        }
        button.admin:hover {
            background: #b91c1c;
        }
        button.success {
            background: #059669;
        }
        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        .test-result.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .test-result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .test-result.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .status {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status.logged-out {
            background: #fee2e2;
            color: #991b1b;
        }
        .status.logged-in {
            background: #d1fae5;
            color: #065f46;
        }
        .user-info {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .note {
            background: #fef3c7;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîê LearnTAV Authentication Test</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            Test both User and Admin authentication systems
        </p>

        <!-- Current Status -->
        <div id="currentStatus" class="status logged-out">
            <strong>Status:</strong> <span id="statusText">Not Authenticated</span>
            <div id="userInfo" class="user-info" style="display: none;"></div>
        </div>

        <!-- Admin Authentication Test -->
        <div class="test-section">
            <h2>üîí Admin Authentication Test</h2>
            <div class="credentials">
                <h3>Required Admin Credentials:</h3>
                <p><strong>Username:</strong> admin@learntav.com</p>
                <p><strong>Password:</strong> AdminPass123!</p>
                <p><strong>Code:</strong> 0410</p>
            </div>
            <button class="admin" onclick="testAdminAuth()">üîê Test Admin Login</button>
            <button class="admin" onclick="goToAdminPanel()">üèõÔ∏è Go to Admin Panel</button>
            <div id="adminResult"></div>
        </div>

        <!-- User Authentication Test -->
        <div class="test-section">
            <h2>üë§ User Authentication Test</h2>
            <div class="note">
                <strong>Note:</strong> A test user account will be automatically created for demonstration.
            </div>
            <div class="credentials">
                <h3>Test User Credentials:</h3>
                <p><strong>Your Email:</strong> ariquery@gmail.com</p>
                <p><strong>Your Password:</strong> ZazuR0cks78!</p>
                <p><strong>Test Email:</strong> test@learntav.com</p>
                <p><strong>Test Password:</strong> TestPass123!</p>
            </div>
            <button onclick="testUserRegister()">üìù Test User Registration</button>
            <button onclick="testUserLogin()">üë§ Test User Login</button>
            <button onclick="openMainSite()">üè† Test on Main Site</button>
            <div id="userResult"></div>
        </div>

        <!-- Current User Session Info -->
        <div class="test-section">
            <h2>üìä Session Information</h2>
            <button onclick="checkSession()">üîç Check Current Session</button>
            <button onclick="clearAllSessions()">üßπ Clear All Sessions</button>
            <div id="sessionResult"></div>
        </div>
    </div>

    <!-- Load Authentication Scripts -->
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/unified-auth-fix.js"></script>
    <script src="auth-diagnostic-tool.js"></script>
    <script src="assets/js/auth-ui.js"></script>
    <script src="assets/js/emergency-fix.js"></script>
    <script src="admin/admin-auth.js"></script>
    <script src="admin/admin-auth-ui.js"></script>

    <script>
        // Wait for scripts to load
        setTimeout(initializeTests, 1000);

        function initializeTests() {
            console.log('üß™ Initializing authentication tests...');
            updateStatus();
            
            // Check if all required systems are loaded
            const systems = {
                'LearnTAVAuth': window.LearnTAVAuth,
                'LearnTAVAuthUI': window.LearnTAVAuthUI,
                'LearnTAVAdminAuth': window.LearnTAVAdminAuth,
                'LearnTAVAdminAuthUI': window.LearnTAVAdminAuthUI
            };

            console.log('üîç Checking loaded systems:', systems);
            
            let allLoaded = true;
            for (const [name, system] of Object.entries(systems)) {
                if (!system) {
                    console.error(`‚ùå ${name} not loaded`);
                    allLoaded = false;
                } else {
                    console.log(`‚úÖ ${name} loaded successfully`);
                }
            }

            if (allLoaded) {
                showResult('sessionResult', 'success', '‚úÖ All authentication systems loaded successfully!');
            } else {
                showResult('sessionResult', 'error', '‚ùå Some authentication systems failed to load. Check console for details.');
            }
        }

        function updateStatus() {
            const statusDiv = document.getElementById('currentStatus');
            const statusText = document.getElementById('statusText');
            const userInfo = document.getElementById('userInfo');

            if (window.LearnTAVAuth && window.LearnTAVAuth.currentUser) {
                const user = window.LearnTAVAuth.currentUser;
                statusDiv.className = 'status logged-in';
                statusText.textContent = `Logged in as ${user.fullName} (${user.role})`;
                userInfo.innerHTML = `
                    <strong>User Details:</strong><br>
                    Email: ${user.email}<br>
                    Role: ${user.role}<br>
                    ID: ${user.id}
                `;
                userInfo.style.display = 'block';
            } else if (window.LearnTAVAdminAuth && window.LearnTAVAdminAuth.isAuthenticated) {
                statusDiv.className = 'status logged-in';
                statusText.textContent = 'Logged in as Administrator';
                userInfo.innerHTML = '<strong>Admin Session Active</strong>';
                userInfo.style.display = 'block';
            } else {
                statusDiv.className = 'status logged-out';
                statusText.textContent = 'Not Authenticated';
                userInfo.style.display = 'none';
            }
        }

        async function testAdminAuth() {
            if (!window.LearnTAVAdminAuth) {
                showResult('adminResult', 'error', '‚ùå Admin authentication system not loaded');
                return;
            }

            try {
                const credentials = {
                    username: 'admin@learntav.com',
                    password: 'AdminPass123!',
                    code: '0410'
                };

                showResult('adminResult', 'info', 'üîÑ Testing admin authentication...');
                
                const result = await window.LearnTAVAdminAuth.authenticate(credentials);
                
                if (result.success) {
                    showResult('adminResult', 'success', `‚úÖ Admin authentication successful! ${result.message}`);
                    updateStatus();
                } else {
                    showResult('adminResult', 'error', '‚ùå Admin authentication failed');
                }
            } catch (error) {
                showResult('adminResult', 'error', `‚ùå Admin authentication error: ${error.message}`);
            }
        }

        async function testUserRegister() {
            if (!window.LearnTAVAuth) {
                showResult('userResult', 'error', '‚ùå User authentication system not loaded');
                return;
            }

            try {
                const userData = {
                    fullName: 'Test User Demo',
                    email: 'demo@learntav.com',
                    password: 'DemoPass123!',
                    confirmPassword: 'DemoPass123!',
                    rememberMe: true,
                    acceptTerms: true
                };

                showResult('userResult', 'info', 'üîÑ Testing user registration...');
                
                const result = await window.LearnTAVAuth.register(userData);
                
                if (result.success) {
                    showResult('userResult', 'success', `‚úÖ User registration successful! Welcome ${result.user.fullName}`);
                    updateStatus();
                } else {
                    showResult('userResult', 'error', '‚ùå User registration failed');
                }
            } catch (error) {
                showResult('userResult', 'error', `‚ùå User registration error: ${error.message}`);
            }
        }

        async function testUserLogin() {
            if (!window.LearnTAVAuth) {
                showResult('userResult', 'error', '‚ùå User authentication system not loaded');
                return;
            }

            try {
                const credentials = {
                    email: 'ariquery@gmail.com',
                    password: 'ZazuR0cks78!',
                    rememberMe: true
                };

                showResult('userResult', 'info', 'üîÑ Testing user login...');
                
                const result = await window.LearnTAVAuth.login(credentials);
                
                if (result.success) {
                    showResult('userResult', 'success', `‚úÖ User login successful! Welcome back ${result.user.fullName}`);
                    updateStatus();
                } else {
                    showResult('userResult', 'error', '‚ùå User login failed');
                }
            } catch (error) {
                showResult('userResult', 'error', `‚ùå User login error: ${error.message}`);
            }
        }

        function checkSession() {
            let sessionInfo = '<strong>Session Details:</strong><br>';

            // Check user session
            if (window.LearnTAVAuth && window.LearnTAVAuth.currentUser) {
                const user = window.LearnTAVAuth.currentUser;
                sessionInfo += `<br>üë§ User Session Active:<br>`;
                sessionInfo += `Name: ${user.fullName}<br>`;
                sessionInfo += `Email: ${user.email}<br>`;
                sessionInfo += `Role: ${user.role}<br>`;
            }

            // Check admin session  
            if (window.LearnTAVAdminAuth && window.LearnTAVAdminAuth.isAuthenticated) {
                const adminSession = window.LearnTAVAdminAuth.getSessionInfo();
                sessionInfo += `<br>üîí Admin Session Active:<br>`;
                sessionInfo += `Username: ${adminSession.username}<br>`;
                sessionInfo += `Expires: ${new Date(adminSession.expires).toLocaleString()}<br>`;
            }

            // Check local storage
            const userStorage = localStorage.getItem('learntav_users');
            const adminStorage = localStorage.getItem('admin_auth_session');
            
            sessionInfo += `<br>üíæ Storage Status:<br>`;
            sessionInfo += `User Storage: ${userStorage ? 'Available' : 'Empty'}<br>`;
            sessionInfo += `Admin Storage: ${adminStorage ? 'Available' : 'Empty'}<br>`;

            if (!window.LearnTAVAuth?.currentUser && !window.LearnTAVAdminAuth?.isAuthenticated) {
                sessionInfo = '<strong>No Active Sessions</strong><br>All authentication systems are logged out.';
            }

            showResult('sessionResult', 'info', sessionInfo);
        }

        function clearAllSessions() {
            // Clear user sessions
            if (window.LearnTAVAuth) {
                window.LearnTAVAuth.clearAllSessions();
            }

            // Clear admin sessions
            if (window.LearnTAVAdminAuth) {
                window.LearnTAVAdminAuth.logout();
            }

            // Clear all local storage auth data
            localStorage.removeItem('learntav_users');
            localStorage.removeItem('admin_auth_session');
            sessionStorage.clear();

            showResult('sessionResult', 'success', '‚úÖ All sessions cleared successfully');
            updateStatus();
        }

        function goToAdminPanel() {
            window.open('admin/index.html', '_blank');
        }

        function openMainSite() {
            window.open('index.html', '_blank');
        }

        function showResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        // Update status periodically
        setInterval(updateStatus, 5000);
    </script>
</body>
</html>